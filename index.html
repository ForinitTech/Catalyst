import os
import tweepy
from requests_oauthlib import OAuth1Session
from dotenv import load_dotenv
from google.cloud import storage
import tempfile
import json

# Load environment variables from .env
load_dotenv()

# API credentials from environment variables
api_key = os.getenv("API_KEY")
api_key_secret = os.getenv("API_KEY_SECRET")
access_token = os.getenv("ACCESS_TOKEN")
access_token_secret = os.getenv("ACCESS_TOKEN_SECRET")
bearer_token = os.getenv("BEARER_TOKEN")

# Authentication for Tweepy
client = tweepy.Client(
    bearer_token=bearer_token,
    consumer_key=api_key,
    consumer_secret=api_key_secret,
    access_token=access_token,
    access_token_secret=access_token_secret
)

# Media upload function
def upload_media(media_path):
    print(f"Uploading media from path: {media_path}")
    url = "https://upload.twitter.com/1.1/media/upload.json"
    oauth = OAuth1Session(api_key, api_key_secret, access_token, access_token_secret)
    with open(media_path, 'rb') as media_file:
        files = {'media': media_file}
        response = oauth.post(url, files=files)

        # Debugging the response from Twitter API
        print(f"Response status code: {response.status_code}")
        print(f"Response content: {response.text}")

        if response.status_code == 200:
            media_id = response.json()['media_id']
            print(f"Media uploaded successfully. Media ID: {media_id}")
            return media_id
        return None

# Cloud Function
def tweet_with_media(request):
    request_json = request.get_json(silent=True)
    request_args = request.args

    # Get data from the request body (if provided)
    tweet_text = request_json.get('tweet_text') if request_json else request_args.get('tweet_text')
    media = request.files['media'] if 'media' in request.files else None

    # Debugging: Check if the files and form data are correctly received
    print(f"Received POST request at /tweet route")
    print(f"Tweet text: {tweet_text}")
    print(f"Media file name: {media.filename}")

    # Save the file temporarily and upload it
    if media:
        with tempfile.NamedTemporaryFile(delete=False) as tmp_file:
            media_path = tmp_file.name
            media.save(media_path)

            # Upload the media to Twitter
            media_id = upload_media(media_path)

            if media_id:
                # Posting the tweet with the media ID
                response = client.create_tweet(
                    text=tweet_text,
                    media_ids=[media_id]
                )

                # Return a success response with CORS headers
                return json.dumps({
                    "message": "Tweet posted successfully!",
                    "tweet": response.data
                }), 200, {
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
                    'Access-Control-Allow-Headers': 'Content-Type'
                }
            else:
                return json.dumps({"error": "Failed to upload media"}), 400, {
                    'Access-Control-Allow-Origin': '*',
                    'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
                    'Access-Control-Allow-Headers': 'Content-Type'
                }

    return json.dumps({"error": "No media found in request"}), 400, {
        'Access-Control-Allow-Origin': '*',
        'Access-Control-Allow-Methods': 'POST, GET, OPTIONS',
        'Access-Control-Allow-Headers': 'Content-Type'
    }

